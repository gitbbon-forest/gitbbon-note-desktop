이 앱은 로컬저장소와 원격저장소(github)가 있다.
사용자는 sync 버튼을 누르면 클라우드와 동기화가 된다. 또는 사용자가 커밋 버튼을 누르면 본 로직이 작동한다.
로컬에는 저장소들의 목록을 .gitbbon-local.json에 저장하고 각 저장소 별로 아래 속성이 있다.
- syncedAt은 마지막으로 동기화 한 시간이 있다. 이 값이 없다면 로컬에만 있는 저장소라는 뜻이다.
- modifiedAt은 마지막으로 수정한 시간이 있다. 이 값이 없다면 수정한 적이 없다는 뜻이다.
sync가 동작할 때 로컬에 있는 저장소에 있는 저장소와 원격의 저장소 정보를 모두 수집해서 아래와 같은 처리를 한다.
- 로컬을 중심으로 원격 처리 시나리오
-- syncedAt이 있는데 remote url에 해당하는 저장소가 없다 => 원격이 삭제된 것이기에 로컬을 휴지통으로 삭제해야 한다. => 다른 머신에도 저장소가 있다면 해당 저장소도 syncedAt가 있을테고 원격은 없을테니 로컬이 삭제되니까 문제 없음.
-- syncedAt이 있는데 remote url에 해당하는 저장소가 있다 => 할 것 없다.
-- syncedAt이 없고 remote url이 없다 => 원격을 생성하고 push 한다
-- syncedAt이 없고 remote url에 같은 이름의 저장소가 있다 =>
--- modifiedAt이 있다 : 로컬에서 작업한 것이 있기에 로컬을 보존해야 한다. => 로컬의 디렉토리 명을 (gitbbon-note-ORIGIANL_NAME+TIMESTAMP)으로 변경하고 원격 저장소를 생성한다.
--- modifiedAt이 없다 : 로컬에서 작업한 것이 없기에 로컬은 보존가치가 없다 => 로컬을 지우고 원격 저장소를 clone 한 후에 workspace를 다시 연다.
- 원격을 기준으로 로컬 처리 시나리오
-- 원격에 있는데 로컬에 remote url에 해당하는 로컬 저장소 이름이 없다 => 로컬을 복제한다. : 폴더명을 바꾸는 것은 정합성을 따지는데 문제가 안됨

기타 :
sync가 되면 모든 저장소에 대해서 pull/push를 진행한다. 선별적으로 하지 않는다. (원격의 수정도 반영하기 위험)
모든 원격/로컬 저장소는 로컬과 클라우드에 반드시 존재해야 하는 것으로 간주한다. 선별적으로 존재여부를 선택하는 기능은 지금 제공하지 않는다. (복잡성을 낮추기 위함)
같은 저장소 안에서의 충돌이 발생하면 ai가 개입해서 자동 병합해도 안전하다면 자동병합을 하고, 위험하다면 상황을 사용자에게 알려주고 직접 병합할 수 있는 merge도구를 제공한다.
로컬 폴더명을 수동으로 변경해도 정합성은 remote url로 하기 때문에 문제가 되지 않는다.
저장소 이름을 수동으로 변경해도 결국 정합성은 remote url로 하기 때문에 문제가 되지 않는다.

gitbbon-manager의 저장소 생성/삭제와 관련한 동기화 로직을 위와 같이 정리해봤는데, 네트워크 오류와 같은 시스템적인 예외상황을 제외하고 사용자의 개입(로컬이나 원격 수동삭제 등)으로 인한 문제점까지 포괄해서 사용자의 개입을 최소화하면서 알아서 상황에 맞게 저장소 존재에 대한 동기화 로직으로 95%이상의 상황을 커버하고 있는지 평가해줘.
